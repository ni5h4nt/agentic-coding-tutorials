"""
passgen - A secure password generator with configurable length and character sets.

Generated by cli-generator.
"""

import secrets
import string
import sys
from typing import Optional

import click


# Character sets
UPPERCASE = string.ascii_uppercase
LOWERCASE = string.ascii_lowercase
DIGITS = string.digits
SYMBOLS = "!@#$%^&*()_+-=[]{}|;:,.<>?"
AMBIGUOUS = "0O1lI"

# Presets configuration
PRESETS = {
    "pin": {
        "length": 4,
        "uppercase": False,
        "lowercase": False,
        "digits": True,
        "symbols": False,
        "description": "4-digit PIN code",
    },
    "memorable": {
        "length": 12,
        "uppercase": True,
        "lowercase": True,
        "digits": True,
        "symbols": False,
        "description": "Easy to remember, moderate security",
    },
    "strong": {
        "length": 16,
        "uppercase": True,
        "lowercase": True,
        "digits": True,
        "symbols": True,
        "description": "Strong password for most uses",
    },
    "paranoid": {
        "length": 32,
        "uppercase": True,
        "lowercase": True,
        "digits": True,
        "symbols": True,
        "description": "Maximum security password",
    },
}


def _build_charset(
    uppercase: bool = True,
    lowercase: bool = True,
    digits: bool = True,
    symbols: bool = False,
    exclude: str = "",
    no_ambiguous: bool = False,
) -> str:
    """Build character set based on options."""
    charset = ""
    if uppercase:
        charset += UPPERCASE
    if lowercase:
        charset += LOWERCASE
    if digits:
        charset += DIGITS
    if symbols:
        charset += SYMBOLS

    # Remove excluded characters
    if exclude:
        charset = "".join(c for c in charset if c not in exclude)

    # Remove ambiguous characters
    if no_ambiguous:
        charset = "".join(c for c in charset if c not in AMBIGUOUS)

    return charset


def _generate_password(charset: str, length: int) -> str:
    """Generate a secure random password."""
    if not charset:
        raise click.ClickException("No characters available. Check your options.")
    return "".join(secrets.choice(charset) for _ in range(length))


def _calculate_entropy(password: str) -> float:
    """Calculate password entropy in bits."""
    import math

    charset_size = len(set(password))
    if charset_size == 0:
        return 0.0
    return len(password) * math.log2(charset_size)


def _analyze_password(password: str) -> dict:
    """Analyze password characteristics."""
    return {
        "length": len(password),
        "has_uppercase": any(c in UPPERCASE for c in password),
        "has_lowercase": any(c in LOWERCASE for c in password),
        "has_digits": any(c in DIGITS for c in password),
        "has_symbols": any(c in SYMBOLS for c in password),
        "unique_chars": len(set(password)),
        "entropy": _calculate_entropy(password),
    }


def _get_strength_rating(entropy: float, length: int, min_length: int) -> tuple[str, str]:
    """Get strength rating based on entropy and length."""
    if length < min_length:
        return "weak", "red"
    if entropy < 28:
        return "very weak", "red"
    if entropy < 36:
        return "weak", "red"
    if entropy < 60:
        return "moderate", "yellow"
    if entropy < 128:
        return "strong", "green"
    return "very strong", "bright_green"


@click.group()
@click.version_option(version="1.0.0", prog_name="passgen")
@click.option("--verbose", "-v", is_flag=True, help="Enable verbose output.")
@click.option("--quiet", "-q", is_flag=True, help="Suppress non-essential output.")
@click.option("--no-color", is_flag=True, help="Disable colored output.")
@click.pass_context
def cli(ctx: click.Context, verbose: bool, quiet: bool, no_color: bool) -> None:
    """A secure password generator with configurable length and character sets."""
    ctx.ensure_object(dict)
    ctx.obj["verbose"] = verbose
    ctx.obj["quiet"] = quiet
    ctx.obj["no_color"] = no_color

    if no_color:
        ctx.color = False


@cli.command()
@click.option("--length", "-l", type=int, default=16, help="Password length.")
@click.option("--uppercase/--no-uppercase", "-U", default=True, help="Include uppercase letters (A-Z).")
@click.option("--lowercase/--no-lowercase", "-L", default=True, help="Include lowercase letters (a-z).")
@click.option("--digits/--no-digits", "-d", default=True, help="Include digits (0-9).")
@click.option("--symbols", "-s", is_flag=True, help="Include symbols (!@#$%^&*).")
@click.option("--exclude", "-x", type=str, default="", help="Characters to exclude.")
@click.option("--count", "-n", type=int, default=1, help="Number of passwords to generate.")
@click.option("--no-ambiguous", is_flag=True, help="Exclude ambiguous characters (0O1lI).")
@click.pass_context
def generate(
    ctx: click.Context,
    length: int,
    uppercase: bool,
    lowercase: bool,
    digits: bool,
    symbols: bool,
    exclude: str,
    count: int,
    no_ambiguous: bool,
) -> None:
    """Generate a random password.

    Examples:
        passgen generate -l 24 -s -n 5
        passgen generate --length 20 --no-digits
        passgen generate -l 12 --no-ambiguous
    """
    if length < 1:
        raise click.ClickException("Password length must be at least 1.")

    if count < 1:
        raise click.ClickException("Count must be at least 1.")

    charset = _build_charset(
        uppercase=uppercase,
        lowercase=lowercase,
        digits=digits,
        symbols=symbols,
        exclude=exclude,
        no_ambiguous=no_ambiguous,
    )

    verbose = ctx.obj.get("verbose", False)
    quiet = ctx.obj.get("quiet", False)

    if verbose and not quiet:
        click.echo(f"Character set size: {len(charset)}")
        click.echo(f"Generating {count} password(s) of length {length}")

    passwords = [_generate_password(charset, length) for _ in range(count)]

    for password in passwords:
        click.echo(password)


@cli.command()
@click.argument("password")
@click.option("--verbose", "-v", is_flag=True, help="Show detailed analysis.")
@click.option("--min-length", "-m", type=int, default=8, help="Minimum required password length.")
@click.pass_context
def strength(ctx: click.Context, password: str, verbose: bool, min_length: int) -> None:
    """Analyze password strength.

    Examples:
        passgen strength "MyP@ssw0rd123"
        passgen strength "secret" --verbose
        passgen strength "MyPassword" --min-length 12
    """
    analysis = _analyze_password(password)
    rating, color = _get_strength_rating(analysis["entropy"], analysis["length"], min_length)

    no_color = ctx.obj.get("no_color", False)
    quiet = ctx.obj.get("quiet", False)

    if quiet:
        click.echo(rating)
        return

    # Display rating
    if no_color:
        click.echo(f"Strength: {rating.upper()}")
    else:
        click.secho(f"Strength: {rating.upper()}", fg=color, bold=True)

    # Check minimum length
    if analysis["length"] < min_length:
        if no_color:
            click.echo(f"Warning: Password is shorter than minimum length ({min_length})")
        else:
            click.secho(
                f"Warning: Password is shorter than minimum length ({min_length})",
                fg="red",
            )

    if verbose:
        click.echo(f"\nDetails:")
        click.echo(f"  Length: {analysis['length']}")
        click.echo(f"  Unique characters: {analysis['unique_chars']}")
        click.echo(f"  Entropy: {analysis['entropy']:.1f} bits")
        click.echo(f"  Has uppercase: {'Yes' if analysis['has_uppercase'] else 'No'}")
        click.echo(f"  Has lowercase: {'Yes' if analysis['has_lowercase'] else 'No'}")
        click.echo(f"  Has digits: {'Yes' if analysis['has_digits'] else 'No'}")
        click.echo(f"  Has symbols: {'Yes' if analysis['has_symbols'] else 'No'}")


@cli.command()
@click.option(
    "--use",
    "-u",
    type=click.Choice(["pin", "memorable", "strong", "paranoid"]),
    help="Use a preset to generate password.",
)
@click.option("--list", "list_presets", is_flag=True, help="List available presets.")
@click.pass_context
def presets(ctx: click.Context, use: Optional[str], list_presets: bool) -> None:
    """List or use predefined password presets.

    Examples:
        passgen presets --list
        passgen presets --use strong
        passgen presets -u paranoid
    """
    quiet = ctx.obj.get("quiet", False)
    no_color = ctx.obj.get("no_color", False)

    if list_presets or use is None:
        if not quiet:
            click.echo("Available presets:\n")
        for name, config in PRESETS.items():
            if quiet:
                click.echo(name)
            else:
                if no_color:
                    click.echo(f"  {name}")
                else:
                    click.secho(f"  {name}", fg="cyan", bold=True)
                click.echo(f"    {config['description']}")
                click.echo(f"    Length: {config['length']}, Symbols: {'Yes' if config['symbols'] else 'No'}")
                click.echo()
        return

    if use:
        preset = PRESETS[use]
        charset = _build_charset(
            uppercase=preset["uppercase"],
            lowercase=preset["lowercase"],
            digits=preset["digits"],
            symbols=preset["symbols"],
        )
        password = _generate_password(charset, preset["length"])
        click.echo(password)


def main() -> None:
    """Main entry point for the CLI."""
    try:
        cli(obj={})
    except Exception as e:
        click.secho(f"Error: {e}", fg="red", err=True)
        sys.exit(1)


if __name__ == "__main__":
    main()
